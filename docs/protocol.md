<div align="center">

# 聊天室协议

</div>

> 注意：
>
> - 协议内的长度编码均采用**大端序**
> - 布局的区间大小单位为**字节**

## 短链接

### 请求

#### 请求头

**头是变长的**，因为方法使用字符串描述。

**结构**：

| 字段 | 类型 | 描述 |
|-:|:-:|:-|
| **method** | `String` | **方法**，服务端路由凭此将请求转发给正确的处理者 |
| **length** | `u16` | 体的大小，单位为**字节**。上限为**10485760**B，即**10MB** |

**布局**：

```
  8 + <字符串长度>       2
|     method       | length |
```

#### 请求体

体容纳通信的内容。

**体是变长的**，其长度由头的`length`字段指定。

体的字节流具体**反序列化**成何类型，由头的`method`字段指定。


### 响应

#### 响应头

响应头是**定长的**，本协议只提供**有限个**状态码。

**结构**：

| 字段 | 类型 | 描述 |
|-:|:-:|:-|
| **status** | `u8` | **状态码**，服务端对请求处理的结果 |
| **length** | `u64` | 体的大小，单位为**字节** |

**布局**：

```
    1        8
| status | length |
```

#### 响应体

当响应状态码为**OK**时，响应体会携带的大小为`length`字节的数据；其余情况，响应体不携带数据。

#### 状态码

| 号码 | 含义 |
|:-:|:-|
| 0 | OK |


### 接口

- 短连接测试
  - 请求方法：`ping`
  - 期待响应：`"pong"`

- 建立长连接
  - 请求方法：`persistent`
  - 期待响应: OK



## 长连接

### 头

**头是变长的**，因为方法使用字符串描述。

**结构**：

| 字段 | 类型 | 描述 |
|-:|:-:|:-|
| **method** | `String` | **方法**，匹配执行者的凭证 |
| **length** | `u16` | 体的大小，单位为**字节**。上限为10485760B，即10MB |

**布局**：

```
  8 + <字符串长度>       2
|     method       | length |
```

### 体

体容纳通信的内容。

**体是变长的**，其长度由头的`length`字段指定。

体的字节流具体**反序列化**成何类型，由头的`method`字段指定。

### 接口

- 发起长连接测试
  - 方法：`ping`
  - 含义：接受到该消息的一端应该发送`pong`

- 响应长连接测试
  - 方法：`pong`
  - 含义：响应`ping`消息

- 回声
  - 方法：`echo`
  - 含义：将用户所发送信息重新发回用户
  - 体：
    ```
    {
      /// 之前发送的目标ID
      to: u32,
      /// 发言所在上下文
      context: Context(Private|Group),
      /// 内容
      content: String,
    }
    ```

- 私信
  - 方法：`private-message`
  - 含义：向一个用户发送私信；接收到一个用户的私信
  - 体：
    ```
    {
      /// 目标用户 或 来源用户
      uid: u32,
      /// 内容
      content: String,
    }
    ```
